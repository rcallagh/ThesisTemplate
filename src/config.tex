\chapter{ConFiG: Contextual Fibre Growth}
\label{chap:config}

\chaptertoc{}

\begin{chapterabstract}
  This chapter introduces a series of mechanisms which were added to improve the initial implementation of ConFiG described in \Cref{chap:ipmi-implementation} and the biological fibre growth processes which inspire these mechanisms.

  These improvements are tested against the state of the art MEDUSA algorithm and simulated \ac{dMRI} signals compared to real \ac{dMRI} signals from the \acl{WM} of a healthy subject.
\end{chapterabstract}

\section{Introduction}
\label{sec:config_introduction}
Numerical phantoms play a valuable role in the development and validation of many magnetic resonance imaging (MRI) techniques.
In particular, numerical phantoms are often used when developing diffusion MRI (dMRI) microstructure imaging techniques where simulations of the dMRI signal in phantoms with known microstructural properties are used in lieu of an in vivo ground truth measure of microstructure \cite{Alexander2017}.
While recently numerical phantoms have proven useful for validating microstructure imaging of grey matter \cite{Palombo2020}, they have more commonly been used for validating white matter (WM) microstructure, with many studies comparing parameter estimates from fitting their models to the known ground truth from the phantoms e.g. \cite{Li2019,Jelescu2017,Scherrer2016,Tariq2016,Daducci2015,Nilsson2017,Xu2014,Zhang2012,Nilsson2010}.
Some recent works directly estimate microstructural features using fingerprinting techniques and machine learning to match simulated signals and the corresponding ground truth microstructure of the numerical phantom to the measured signal\cite{Hill2019,Palombo2018a,Rensonnet2018,Nedjati-Gilani2017}.
As well as affecting the dMRI signal, microstructural features also influence other MR techniques such as susceptibility-weighted imaging \cite{Li2012,Lee2010}.
For instance, Xu et al. \cite{Xu2018} recently used simulations to show that using realistic axonal models rather than simple circular cylinders affects the MR signal.
Therefore, it is important to the MRI community to generate realistic WM numerical phantoms which accurately capture microstructural features in order to get realistic simulated signal.

Typically, however, there is a mismatch between the complexity of true brain tissue microstructure and the models used in simulation, with simulations simplifying the microstructure.
On one hand, ex vivo electron microscopy (EM) studies have revealed the high complexity of real axonal morphology \cite{Abdollahzadeh2019,Lee2019b,Salo2018}.
Reconstructions of axons from these studies show that real WM contains axons with complex morphologies on an individual axon basis such as undulation, beading and non-circular cross sections, as well as non-trivial configurations including orientation dispersion and crossing bundles.
On the other hand, the models used in simulation studies often represent axons in WM using simplistic geometrical representations such as parallel cylinders with uniform \cite{Fieremans2010,Nilsson2010,Nilsson2009,Ford1997} or polydisperse \cite{Alexander2010,Hall2009} radii.
Some studies investigate the effect of differing configurations of fibres such as simple crossing \cite{Rensonnet2017,Zhang2011a} and orientation-dispersed \cite{Tariq2016,Zhang2012,Zhang2011} fibre bundles.
A few groups generate WM numerical phantoms with complex fibre configurations for the application to  tractography \cite{Close2009,Neher2014}; however realistic microstructural morphology is not the focus of these approaches.

Other studies introduce more microstructural complexity into the numerical phantoms, typically only considering one mode of morphological variation at a time; some examples of this include harmonic beading \cite{Budde2010,Landman2010}, spines \cite{Palombo2018}, undulation \cite{Brabec2019,Nilsson2012} and myelination \cite{Brusini2019}.


Recently, a number of groups have attempted the challenge of combining these features to generate phantoms approaching the morphological complexity and density of real tissue.
The most common approach to this is the packing of fibres into densely packed configurations \cite{Close2009,Ginsburger2018,Ginsburger2019,Rafael-Patino2018}.
The typical approach, as taken in the state-of-the-art MEDUSA algorithm \cite{Ginsburger2019}, is to generate a set of overlapping fibres decomposed into small segments and iteratively refine their positions to remove the overlap between them.
Despite their recent progress, further advance of this class of techniques may be limited, because nature does not create fibres before attempting to pack them together.
Instead, real axons are guided by chemical cues and fit into available space as they grow \cite{Price2017,Lowery2009}.
Mimicking the natural fibre genesis may prove important for building more realistic phantoms.

To this end, we propose Contextual Fibre Growth (ConFiG), an approach to generate WM numerical phantoms that emulates natural fibre growth. ConFiG generates WM numerical phantoms by growing fibres one-by-one, mimicking a set of key mechanisms which govern real axonal growth. A preliminary implementation of ConFiG was presented in \cite{Callaghan2019}.
We assess the performance of ConFiG by measuring the impact of each of the biologically inspired mechanisms on the achievable phantom density and comparing against state-of-the-art MEDUSA phantoms.
To test how realistic ConFiG phantoms are, we compare the microstructural properties of the phantoms to measured data from electron microscopy and compare simulated dMRI signal in the phantoms to real dMRI data.

The rest of the paper is organized as follows: \Cref{sec:config_methods} describes the ConFiG algorithm, \Cref{sec:config_experiments} details the experiments outlined above and \Cref{sec:config_results,sec:config_discussion} summarise the contributions and discuss future work.

\section{Methods}
\label{sec:config_methods}
In this section we describe the ConFiG algorithm, beginning with an overview of the main components in the growth algorithm. We then describe the biological mechanisms motivating ConFiG and how each of these are implemented to give the final ConFiG algorithm.

\subsection{Overview of the ConFiG algorithm}
\label{sec:config-alg-overview}
Given a set of morphological input parameters (target density, orientation distribution and diameter distribution), ConFiG generates a densely packed set of fibres by growing each fibre following a set of biologically motivated rules. The generation of ConFiG numerical phantoms happens in three main steps:
\begin{description}
  \item [STEP 1] Generate initial growth configuration from user inputs
  \item [STEP 2] Grow the fibres using ConFiG growth algorithm
  \item [STEP 3] Generate 3D meshes for dMRI simulation
\end{description}
Each of these steps are discussed in detail below.
\begin{figure}[t]
  \centering
  \includegraphics[width=\textwidth]{figures/config/method_inputs_only.eps}
  \caption[Inputs to the ConFiG algorithm]{Inputs to the ConFiG algorithm for the single bundle case. $L$ defines the size of the area of that the growth will take place in. The target density and fibre radius distribution govern the generation of starting points for each fibre by packing in 2D. Orientation dispersion parameters govern the generation of target points corresponding to each starting point. $N$ defines the number of nodes to use when generating the network. In the case of multiple bundles, starting and target points are generated for each bundle and then combined into the same space which is filled with nodes for the network. }
  \label{fig:config_inputs}
\end{figure}

First, Step 1 is broken down in to three substeps as outlined in \Cref{fig:config_inputs}:
\begin{description}
  \item [STEP 1.1] Generate fibre starting points (~\Cref{fig:config_inputs}a-b). To generate a starting point for each fibre to grow from, ConFiG packs circles with the desired diameter distribution up to the target density (defined in terms of the desired fibre volume fraction) in 2D, following the approach taken in \cite{Hall2009}.

  \item [STEP 1.2] Generate fibre target points (~\Cref{fig:config_inputs}c). To encode the desired orientation distribution, each fibre has a direction drawn from the target distribution which gives a target point for the fibre to grow towards. As a demonstration of the flexibility of the framework, in this work we use the Watson distribution \cite{Mardia2008} for isotropic dispersion and the elliptically symmetric angular Gaussian distribution \cite{Paine2018} for anisotropic orientation dispersion, however other orientation distributions can be defined according to the userâ€™s needs.

  \item [STEP 1.3] Generate growth nodes (~\Cref{fig:config_inputs}d). ConFiG uses a set of pseudorandomly placed points (nodes) to sample the space and encode which regions are occupied by existing fibres. This simplifies collision checking making growth more efficient than a direct collision detection approach involving growing each fibre one small step at a time and checking collisions with existing fibres \cite{Callaghan2019}.
\end{description}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\textwidth]{figures/config/method_without_inputs1.eps}
  \caption[Overview of the ConFiG growth algorithm]{Overview of the basic growth algorithm in ConFiG. In this example, three fibres are shown with a growth network that only contains relevant nodes for the sake of visualisation.  From the set of nodes, a network is constructed using the Delaunay triangulation. Each fibre then grows from node to node, along any edge connected to the current node. The node moved to will be the node with the lowest cost. Once a fibre segment has grown, the network nodes are updated to store information about which nodes are occupied or near to an existing fibres. This contributes to the cost function for any future fibres, penalising moving to nodes too close to existing fibres.  It is not possible to move to any node now inside a fibre as indicated by the removal of this edges from the network (pairs of blue arrows show where this is happening). The next fibres grow, now avoiding existing fibres until all fibres have finished. See Supplementary Video 1 for an animation of this algorithm. }
  \label{fig:config_algorithm}
\end{figure}

Second, Step 2, the main growth algorithm, is broken down into a series of substeps as outlined in \Cref{fig:config_algorithm}:
\begin{description}
  \item [STEP 2.1] Create growth network (~\Cref{fig:config_algorithm}a\&b). In order to encode which nodes a fibre can move to from any other node, the growth nodes are connected using the Delaunay triangulation.

  \item [STEP 2.2] Grow one fibre step (~\Cref{fig:config_algorithm}c-e). Fibres grow one-by-one in a random order along this network towards their target points while avoiding existing fibres. During growth, a fibre must choose in which direction it should grow. This direction is chosen in ConFiG by following a cost function motivated by biological axonal guidance mechanisms (~\Cref{fig:config_algorithm}d), described in \Cref{sec:config_chemoattraction,sec:config_fasciculation}.

  \item [STEP 2.3] Update the network (~\Cref{fig:config_algorithm}f). The growth network is updated in order to store the information about the space this fibre is occupying so that future fibres can avoid it. The simplest way to do this is to store the minimum distance from each node in the network to any existing fibre as in \cite{Callaghan2019}. Additionally, another biologically motivated network updating strategy is described in \Cref{sec:config_dynam_growth}.

  \item [STEP 2.4] Repeat steps 2.2 and 2.3 until fibre reaches target (~\Cref{fig:config_algorithm}g). By default in ConFiG, each fibre will grow completely before the next one starts, meaning that step 5 only needs to be performed once the fibre has finished growing. If fibres are allowed to grow concurrently, step 5 must be performed after each growth step.

  \item [STEP 2.5] Repeat steps 2.2-2.4 for remaining fibres (~\Cref{fig:config_algorithm}h-i). As noted in \Cref{fig:config_algorithm} (e-h), as the network is updated, more and more nodes become inaccessible making the network sparser. This means that some fibres may reach a point from which they cannot grow any further and will become stuck. Biologically inspired mechanisms designed to address this point are described in \Cref{sec:config_fibre_collapse,sec:config_dynam_growth}.
\end{description}

Finally, Step 3, the meshing procedure, is briefly described below and in further detail in \Cref{sec:config_meshing}:
\begin{description}
  \item [STEP 3] Generate 3D fibre meshes. After the growth process, each fibre will be represented by a series of connected 3D points and corresponding diameters at each point. In order to simulate diffusion MRI signals, these fibre skeleta need to be turned into 3D meshes. ConFiG uses a meshing procedure designed to eliminate overlap between fibres.
\end{description}

The basic ConFiG growth algorithm described here is illustrated in \Cref{fig:config_algorithm}, with an animation of the algorithm in Supplementary Video 1. The remainder of this section outlines the biological process governing real axonal growth, and how these processes motivated the final implementation of the ConFiG algorithm.

\subsection{Biological motivation for ConFiG}
\label{sec:config_biol_motiv}
In nature, axons grow following chemical cues in their environment through various mechanisms which either attract or repel fibres to guide their growth \cite{Dent2011,Lowery2009,Mortimer2008,Polleux2010,Price2017,Rauch2013,Sakisaka2005}. In an attempt to emulate real axonal growth, mechanisms motivated by the following guidance processes have been integrated into ConFiG:
\begin{itemize}
  \item Chemoattraction â€“ the process by which fibres are attracted to diffusible chemical cues in their environment \cite{Price2017,Mortimer2008}.
  \item Fibre collapse â€“ a response to a chemorepulsive source whereby a fibre withdraws and regrows in a different direction \cite{Rauch2013}.
  \item Cell adhesion molecules â€“ chemical signals on the surface of cells which guide axons that come into contact with them \cite{Sakisaka2005}.
  \item Fasciculation â€“ the process by which multiple axons come together to form bundles \cite{Price2017,Smit2017}.
\end{itemize}
The following sections detail how mechanisms motivated by these biological processes are implemented in ConFiG while \Cref{fig:config_chemoattraction,fig:config_dynam_growth,fig:config_fasciculation} illustrate these biological processes alongside their ConFiG counterparts.

\subsubsection{Chemoattraction}
\label{sec:config_chemoattraction}
As mentioned in \Cref{sec:config-alg-overview}, as a fibre grows it must choose in which direction it will move. One of the main processes governing the guidance of real axons is chemotropism; a process by which axons respond to diffusible chemical cues in their environment. One key chemotropic mechanism is chemoattraction, in which fibres are attracted along a chemical gradient towards a target region \cite{Price2017}.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/biological_target+cam-01.png}
  \caption[Illustration of the chemoattraction process]{Illustration of two of the biological motivations and how they are implemented in ConFiG. a) Growth towards the target is enforced by means of a cost function encouraging growth towards the target point. b) Fibre collapse is implemented by allowing the fibre to move backwards if it reaches a node from which there are no viable steps. The biological figures are adapted from \cite{Price2017}}
  \label{fig:config_chemoattraction}
\end{figure}

To approximate this chemoattractive mechanism, each fibre is encouraged to grow towards its target point (i.e. the target point acts like a chemoattractive source). From any node in the growth network, the fibre will move along an edge that takes it towards its target while avoiding existing fibres according to a cost function \cite{Callaghan2019}. The chemoattractive mechanism and its ConFiG counterpart are illustrated in \Cref{fig:config_chemoattraction}a.
From a starting node, $s$, the candidate nodes, $c$, that the fibre can move to are any nodes that share an edge with $s$. In addition to its position, each network node stores the maximum fibre diameter, $d_c$, that can be sustained at that node without intersecting another fibre. The fibre will move to a candidate node according to a cost function consisting of two terms; $l_t$, which penalises taking very large steps or moving away from the target point, $t$, and $l_d$, which penalises moving to a position where $d_c$ is low meaning that the fibre will have to shrink. The cost function for a fibre at a position, $s$, to move to a candidate node, $c$, given a target point, $t$, is (Callaghan et al., 2019)
\begin{align}
  l &= l_t+fl_d  \,,\label{eq:original_cost}\\
      \mathrm{where}\nonumber\\
  l_t &=  \frac{1}{2} \cdot \frac{\|s-c\|}{1+ \|s-c\|} \cdot \left(1- \frac{\left(\left(c-s\right) \cdot \left(t-s\right)\right)}{\|c-s\|\|t-s\|}\right)\,, \label{eq:original_lt}\\
  l_d &=\mathrm{max}\left(0, \frac{1}{d_0} \left(d_0 - d_c \right)\right) \,. \label{eq:original_ld}
\end{align}
Here, $d_0$ is the target diameter of the fibre and $f$ is a weighting factor between the two terms. In this work, $f$ is fixed to 0.2 to more strongly weight growth towards the target.

The next node for a fibre will be the candidate node which has the lowest cost according to Equation (1). This method of finding a path through the triangulation by choosing the lowest cost node at each position amounts to a greedy best-first pathfinding approach with a heuristic given by Equation (1).

Growing fibres along the network using just this chemoattractive mechanism is the minimal implementation of ConFiG that will generate substrates to try and meet the morphological inputs. There are some limitations to this minimal approach however; the greedy growth and the sparse sampling of the space means that fibres can grow into regions from which they cannot grow further and become stuck. Additionally, in this approach, fibres grow independently of one another, whereas real fibres grow forming bundles in the process known as fasciculation.

\Cref{sec:config_fibre_collapse,sec:config_dynam_growth,sec:config_fasciculation} describe further mechanisms which were added to enable ConFiG to address these limitations in order to meet more complex morphological priors (e.g. high density and orientation dispersion together).

\subsubsection{Fibre Collapse}
\label{sec:config_fibre_collapse}
As mentioned in \Cref{sec:config_biol_motiv}, in ConFiG a fibre can become stuck when there are no possible next steps because all neighbouring nodes are inaccessible. In an attempt to ameliorate this a process mimicking fibre collapse was implemented, illustrated in \Cref{fig:config_chemoattraction}b.

In ConFiG fibre collapse, the fibre will move back by an initial distance, $g_0$, and regrow from there avoiding any nodes in the route it took previously. If the fibre becomes stuck again, it will move back by a further distance, $g_0+ \delta$, where $\delta$ is the additional distance to step back. This process is repeated until the fibre reaches the target or gets stuck a user-defined maximum number of times. In this work, $g_0=\SI{2}{\micro\metre}$  and $\delta=\SI{5}{\micro\metre}$ in an approximation of the biological fibre collapse process investigated by Rauch et al. \cite{Rauch2013} who show fibres collapsing up to \SI{25}{\micro\metre} back towards the soma. The maximum number of steps back is set to 5, meaning that the maximum step back is \SI{27}{\micro\metre}, in line with real fibres. If there is no possible route after 5 attempts then the fibre will stop growing and will be removed from the phantom. This process of removing stuck fibres means that the resulting substrate may not always have the same density as the input desired fibre density.

\subsubsection{Dynamic Growth Network}
\label{sec:config_dynam_growth}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{figures/config/biological_cam.png}
  \caption[Illustration of the contact guidance mechanism]{Illustration of the contact guidance axonal growth mechanism and the dynamic growth network implemented in ConFiG. The dynamic growth network is implemented as a set of points added around each fibre after growth, enable future fibres to more easily grow along/around existing fibres.}
  \label{fig:config_dynam_growth}
\end{figure}

In the preliminary implementation of ConFiG \cite{Callaghan2019}, the network nodes were initialised pseudorandomly within the growth region and once initialised, the growth network was static, meaning that the nodes and edges of the network were fixed. This limited the growth to the specific instantiation of the network and it could not adapt to where fibres were once they had grown. Furthermore, as illustrated in \Cref{fig:config_algorithm}, as fibres grow, many nodes become inaccessible due to being within fibres meaning that the network becomes gradually sparser.

A dynamic growth network was implemented to ameliorate these effects. Now, once a fibre has reached the target, a number of nodes, $N_{added}$, are generated around the path of the fibre. This gives a denser sampling of the space in regions in which fibres exist and serves to give subsequent fibres more nodes to use to grow along or around that fibre, helping to increase the achievable density by limiting the number of fibres which get stuck. In this work, where the dynamic network is used, $N_{added}=2500$.

This is also loosely motivated by the contact guidance mechanism in which axons are attracted to or repelled by chemical cues on the surface of other cells, known as cell adhesion molecules (CAMs). Here, the added points act like CAMs meaning that a future fibre which grows can use these points near to the fibre to grow around or along it as if it were following contact guidance cues. \Cref{fig:config_dynam_growth} shows how CAMs work in biological axonal growth alongside the ConFiG dynamic network, illustrating the parallels between the two.

\subsubsection{Axon Fasciculation}
\label{sec:config_fasciculation}

\begin{figure}
  \centering
  \includegraphics[width=0.5\textwidth]{figures/config/biological_fasciculate.png}
  \caption[Illustraction of the fasciculation process]{Illustration of how the labelled pathway hypothesis is expected to work in biology and its ConFiG counterpart. Fasciculation is implemented using the cost function term in Eq. 1 which means that fibres in the same bundle are encouraged to stay close to one another.}
  \label{fig:config_fasciculation}
\end{figure}

One particular role CAMs play is in axon fasciculation, the process in which axons follow a so-called pioneer axon closely, forming a bundle \cite{Price2017,Sakisaka2005}. To mimic the process of axon fasciculation, the term in the cost function penalising moving into regions in which the fibre had to shrink, $l_d$ (Equation (3)), was altered to be conditional on which fibre bundle is closest.

A fibre, $f$, with a target diameter, $d_0$, moving to a candidate node, $c$, which has a maximum sustainable diameter $d_c$ will now have $l_d$ given by:
\begin{equation}
  \label{eq:updated_ld}
  l_d = \begin{cases}
    \max\left(0, \frac{1}{d_0} \left(d_0 - d_c\right)\right) & \text{if } b_c \neq b_f \\
    \mathrm{abs}\left(\frac{1}{d_0} \left(d_0 - d_c\right)\right) & \text{if } b_c = b_f
    \end{cases}
\end{equation}

Where $b_f$ is an index identifying the bundle that fibre $f$ belongs to and $b_c$ is the index of the bundle that is closest to $c$ (i.e. the index of the bundle of the fibre that set $d_c$). This means that when $c$ is closest to the same bundle as $f$, the cost function penalises moving away from that bundle as well as shrinkage, whereas when the bundles differ, it only penalises shrinkage.

This new form of the cost function encourages fibres of the same bundle to stick together while still avoiding fibres of different bundles, inspired by the labelled pathway hypothesis, which states that axons join different fascicles based on different CAMs expressed on the fibres \cite{Price2017}. In this case, bundle indices $b_c$ and $b_f$ act like different identifying CAMs. \Cref{fig:config_fasciculation} shows how this fasciculation process is expected to happen in biology alongside how the improved cost function encourages a similar process in ConFiG.

\subsubsection{Global Optimisation}
\label{sec:config_global_optimisation}
Since the growth of fibres in ConFiG takes place on a discrete network of points, the final positions of fibre nodes may be suboptimal for achieving the maximum density. In other words, certain fibresâ€™ nodes may be closer to other fibres than they would ideally be in order to reach their target diameter (i.e. the fibre has had to shrink its diameter at that node).

To mitigate against this, a global optimisation step was added at the end of the growth in a procedure similar to MEDUSA \cite{Ginsburger2019}. For each point, $i$, that is part of a fibre, its nearest $n$ neighbours $(j \in NN(i))$ from other fibres are found; in this work $n=10$. The distance to all of the neighbours is found and the pointâ€™s position is updated from these distances according to the update vector, $\vec{u}_i$
\begin{equation}
  \label{eq:global_opt_update_vec}
\vec{u}_i= \sum_{j \in NN(i)} D(i,j) \cdot \left(\vec{p}_i - \vec{p}_j\right) \,,
\end{equation}
where $\vec{p}_i$ and $\vec{p}_j$ are the locations of point $i$ and $j$. $D(i,j)$ is the function determining whether the interaction is repulsive or attractive:
\begin{equation}
  \label{eq:global_opt_Dij}
  D(i, j) = \mathrm{sgn}\left(r_i + r_j - \|\vec{p}_i - \vec{p}_j\|\right) \,.
\end{equation}

Here, $\mathrm{sgn}$ is the signum function and $r_i$ and $r_j$ are the target radii of point $i$ and $j$. The sum of these radii is the desired distance between the points since that means the fibres are just touching. $D(i,j)$ imposes that the force is repulsive if the points are closer together than the desired radius and attractive if they are further apart. The update vector is scaled such that if $\|\vec{u}_i\| > 0.2r_i$, the update vector is rescaled so that $\|\vec{u}_i\|=0.2r_i$. This acts to prevent the update vector from becoming very large.

There is some biological evidence that this kind of interaction between fibres is important in the fasciculation process. The fasciculation process described in \Cref{sec:config_fasciculation} relies on CAMs detected at the tip of a growing axon, however some studies provide evidence for fasciculation through interactions along axon shafts, known as zippering \cite{Barry2010,Smit2017,Voyiadjis2011}. In zippering, nearby axon shafts attract one another to form more closely packed fascicles, which is a similar process to the global optimisation process in ConFiG.

\subsection{Summary of ConFiG input parameters}
\label{sec:config_summary_of_input}
\Cref{tab:config_parameters} summarises the key parameters that govern the generation of ConFiG phantoms. Parameters are split into those which define the target microstructural morphology and those which define the instantiation of the growth algorithm. For each parameter, the theoretical range is reported alongside the practical range that has been tested so far. This is due to stochastic nature of the algorithm and the interdependence of the parameters. For instance a very large substrate is possible if very large fibres are chosen, but likely impossible with very small fibres since this will require a very large number of fibres and run into memory limitations.

\begin{table}[!h]
  \footnotesize
  \centering
  \caption{Summary of ConFiG parameters split into parameters which define the target microstructural morphology and parameters which define the instantiation of the growth algorithm. For each parameter the theoretical range is reported as well as the practical range that has been tested so far.}
  \label{tab:config_parameters}
  \begin{tabular}{cccr@{}lb{2cm}c}
    \toprule
     \multicolumn{2}{c}{\textbf{Parameter}} & \multicolumn{3}{c}{\textbf{Meaning}} & \centering \textbf{Theoretical Range} & \textbf{Practical Limits Tested} \\ \midrule
     \multirow{7}{*}{\rotatebox[origin=c]{90}{\parbox[c]{3.5cm}{\centering \textbf{Target microstructure parameters}}}}
     & $L$ & \multicolumn{3}{c}{Size of growth region} & \centering $\mathbb{R}_+^3$ & $[0,0,0] \rightarrow [50,50,50]$ \si{\micro\metre} \\
     &$\rho$& \multicolumn{3}{c}{Fibre volume fraction}& \centering$[0,1]$ & $[0,0.8]$ \\
     & $\mu_r$& \multicolumn{3}{c}{Mean radius}& \centering $\mathbb{R}_+$&  $[0.5,2]$ \si{\micro\metre}\\
     & $\sigma_r$& \multicolumn{3}{c}{Standard deviation radius}& \centering$\mathbb{R}_+$& $[0.1,0.5]$ \si{\micro\metre}\\
     & \multirow{3}{*}{$GAD$} & \multirow{3}{2cm}{\centering Global angular dispersion} & Watson & $: \kappa$ & \centering$\mathbb{R}_+$& $[4,100]$ \\
     & & & \multirow{2}{*}{ESAG $\Big\{\!$}& $\ \mu$ & \centering$\mathbb{R}_+$ & $[2,10]$ \\
     & & & & $\ \gamma$ & \centering$\mathbb{R}_+^2$ & $[2,2] \rightarrow [10,10]$\\ \midrule
    \multirow{4}{*}{\rotatebox[origin=c]{90}{\parbox[c]{3cm}{\centering \textbf{Growth algorithm parameters}}}} & $N$ & \multicolumn{3}{c}{Number of growth nodes} & \centering$\mathbb{N}$ & $[0,10^7]$ \\
    & $f$ & \multicolumn{3}{c}{Cost function weighting term} & \centering$[0,1]$ & $[0,0.5]$  \\
    & \multirow{2}{*}{$g_0, \delta$} & \multicolumn{3}{c}{\multirow{2}{4cm}{\centering Fibre collapse initial and subsequent step length}} & \centering\multirow{2}{*}{$\mathbb{R}_+$} & \multirow{2}{*}{$[1,5],[1,5]$ \si{\micro\metre}} \\
    & & & & & \\
    & \multirow{2}{*}{$N_{\text{added}}$} & \multicolumn{3}{c}{\multirow{2}{4cm}{\centering Dynamic network no. nodes added}} & \centering\multirow{2}{*}{$\mathbb{N}$} & \multirow{2}{*}{$[0,5000]$}\\
    & & & & & \\ \bottomrule
  \end{tabular}
\end{table}

\section{Experiments}
\label{sec:config_experiments}
In order to assess the performance of ConFiG, a range of experiments were performed. The first set of experiments were performed in order to explore the impact of each of the biologically inspired growth mechanisms. Another set of experiments aimed to show that ConFiG is able to generate substrates with realistic microstructure by comparing generated substrates with real tissue. Additionally, the relationship between the user-specified target morphology and the final output morphology was investigated by comparing resulting phantoms to their inputs (target density and orientation distribution). Finally, a simulation experiment was performed to assess how well ConFiG phantoms can be used to generate realistic diffusion MRI data. The rest of this section outlines these experiments.

\subsection{Testing the performance of ConFiG}
\label{sec:config_test_perf}
In order to test how each of the biological mechanisms proposed in \Cref{sec:config_methods} impacted on the resulting phantoms, an experiment was devised to measure how phantoms changed when each mechanism was introduced. Four scenarios of interest were generated using several variants of the ConFiG algorithm that included these mechanisms either one at a time or all at once, attempting to grow phantoms as densely as possible:
\begin{itemize}
  \item one bundle of parallel fibres, target density 75\%
  \item one bundle with Watson distributed fibres $(\kappa=8)$, target density 75\%
  \item two perpendicular crossing bundles, intra-bundle target density 40\%
  \item three mutually perpendicular crossing bundles, intra-bundle target density 30\%
\end{itemize}
These target densities were chosen to ensure that the centre of the phantom (i.e. the crossing region for crossed bundles) had a high target density whilst ensuring that each bundle had a reasonable number of fibres to begin with (>50).

The ConFiG variants were tested by generating phantoms for each of the scenarios starting with the same initial conditions. Each phantom was generated 5 times with a different random seed and results averaged across the seeds.

To investigate the impact of the biological mechanisms on dMRI simulation, a comparison was made between real dMRI signals and simulations from ConFiG phantoms. The NODDI model \cite{Zhang2012} was fitted to a WM ROI in the corpus callosum of a Human Connectome Project (HCP) \cite{VanEssen2012} subject to provide sensible input parameters (target fibre density and orientation dispersion) for ConFiG to generate phantoms. We generated phantoms using the two extreme cases: the minimal growth case only using chemoattraction, and the complete ConFiG algorithm using all mechanisms. Whilst the random nature of ConFiG means that the resulting phantom will not have morphology exactly matching the input parameters, this approach ensured that the phantoms were reasonable for this proof of concept experiment.

The dMRI signal was simulated in the phantoms using Camino \cite{Cook2006,Hall2009} with identical simulation conditions in both cases and the measurement scheme corresponding to the HCP dMRI sequence \cite{Sotiropoulos2013a}. An important consideration when performing dMRI simulations is the size of the substrate relative to the diffusion length. The phantom should be large enough that it is bigger than the diffusion length, but not so large as to require excessive computational resources. Owing to the relatively long diffusion time (\SI{43}{\milli\second}) in the HCP sequence, phantoms were extended with reflected copies \cite{Lee2019a,Fieremans2018} to increase their effective size relative to the diffusion length scale.

All dMRI simulations in this work used a bulk diffusivity $D=\SI{2.0}{\micro\metre\squared\per\milli\second}$ in agreement with values used in similar Monte Carlo simulations \cite{Hall2009,Nilsson2009,Rensonnet2017} with $10^5$ spins and $2000$ timesteps. Standard Camino periodic boundaries were used \cite{Hall2009}, with dMRI signal was generated from a central region 75\% the size of the total phantom to avoid boundary effects \cite{Panagiotaki2010}.


\subsection{Diffusion MRI simulation}
\label{sec:config_diffusion_sim}
To qualitatively verify that the simulated diffusion MRI signals from ConFiG phantoms are realistic, simulated signals from ConFiG phantoms were compared to real HCP data \cite{Sotiropoulos2013a,VanEssen2012}.

In the real data, the fibre orientation distribution (FOD) was fit in each voxel using constrained spherical deconvolution in MRTrix \cite{Tournier2019,Tournier2007}. Voxels were selected in regions of interest in the midbody of the corpus callosum (CC), internal capsule (IC), regions in which a single bundle of fibres is found from the FOD. A third voxel was selected in which three crossing fibre populations were found from visual inspection of the FOD (TC).

In each voxel, the diffusion tensor was fit to the signal and the principal eigenvector used to define a major direction of diffusion in the voxel, $n$. From this, the normalised diffusion weighted signal was plotted against $|n\cdot G|$, where $G$ is the gradient direction. Additionally, the direction averaged signal was calculated for each b-shell.

To attempt to generate representative microstructure for each voxel using ConFiG, the NODDI model \cite{Zhang2012} was fitted to the average signal to give some initial parameters for ConFiG. Most importantly, the value of $\kappa$ for the Watson distribution \cite{Mardia2008} estimated using NODDI was used to initialise the orientation dispersion in the ConFiG phantoms used to represent CC ($\kappa=6.2$) and IC $(\kappa=5.5)$ regions. To represent the TC voxel, a phantom generated using three mutually perpendicular crossing bundles was used.

ConFiG phantoms were grown using these initial conditions and the diffusion MRI signal simulated using the Camino Monte Carlo diffusion MRI simulator \cite{Hall2009}. For each phantom, the same processing as with the real data was performed, finding the direction dependent and direction averaged signal per b-shell.

\section{Results}
\label{sec:config_results}

\subsection{Impact of biological mechanisms}
\label{sec:config_result_impact_of_mechanisms}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/improvements_wfascicle_tight.eps}
  \caption[Impact of biological mechanisms in ConFiG]{Demonstration of the impact of each biological growth mechanism on the density achievable with ConFiG. Each bar shows the mean density for each proposed mechanism, error bars show $\pm$ standard error on the mean. MEDUSA values are estimated from Fig. 14 in Ginsberger et al. (Ginsburger et al., 2019).}
  \label{fig:config_res_improvements}
\end{figure}

Each of the proposed biological mechanisms enabled ConFiG to generate phantoms with increased density over the minimal case of chemoattraction only, as is shown in \Cref{fig:config_res_improvements}. Global optimisation resulted in the largest improvement, 17-24\%, consistently giving a large improvement. Other improvements performed better for specific phantom configurations. For instance, fasciculation and the dynamic network produced only modest improvements in crossing fibre configurations (4-6\%), but performed well in the single bundle cases (11-14\%). Fibre collapse was particularly effective in the three perpendicular case, offering 10\% improvement.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/improvements_virthist.png}
  \caption[Impact of biological mechanisms on virtual histology]{Virtual histology demonstrating the impact of biologically inspired mechanism on the final phantom created for one of the parallel phantoms tested. This visually demonstrates the improvement in density. Leftmost image shows the phantom generated with all mechanisms in 3D and the cutting plane used to produce the virtual histology.  }
  \label{fig:config_res_improvements_virthist}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/improvement_3drender.png}
  \caption[Impact of biological mechanisms on 3D phantoms]{Demonstration of the improvement in density achieved when using all mechanisms in ConFiG compared to the minimal implementation using only chemoattraction. Colours chosen to match \Cref{fig:config_res_improvements}. }
  \label{fig:config_res_improvements_3d}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/hcp_old_vs_new_figure_whitebg.png}
  \caption[Impact of improvements on simulated dMRI signal]{Left: Direction averaged signal attenuation for real HCP data (Â± standard deviation over ROI) and simulated data from the minimal ConFiG implementation using only chemoattraction and using all growth mechanisms ConFiG showing that ConFiG can produce realistic dMRI signals. Right: The original and improved ConFiG phantoms used to generate the signal on the left. Simulations performed with $10^5$ spins, 2000 timesteps and HCP measurement scheme (Stamatios N. Sotiropoulos et al., 2013). Diffusivity set to $2.0microm ^2/ms$ , chosen to be consistent with previously reported values (Hall and Alexander, 2009; Nilsson et al., 2009; Rensonnet et al., 2017).  }
  \label{fig:config_res_improvements_sig}
\end{figure}

When combining all of the proposed mechanisms together, the achievable density is higher than any of the improvements individually. This improved performance is comparable to the state of the art, MEDUSA \cite{Ginsburger2019}, with particularly good performance relative to MEDUSA in the crossing fibre configurations.

This improvement in density can be appreciated visually in \Cref{fig:config_res_improvements_virthist} which demonstrates virtual histology of a parallel fibre phantom for each of the mechanisms. Additionally, \Cref{fig:config_res_improvements_3d} visually shows the difference in density of the phantoms in 3D between the minimal case of chemoattraction and all biological mechanism for each fibre configuration.

The improvement in the density of phantoms leads to a much more realistic simulated diffusion MRI signal as demonstrated in \Cref{fig:config_res_improvements_sig}. The root mean square error to the real data is reduced by 10 times when using improved ConFiG.


\subsection{Diffusion MRI simulation}
\label{sec:config_result_dmri_sim}
Simulated data from ConFiG substrates match real dMRI data well, as shown in \Cref{fig:config_res_dMRI}. The direction averaged signal matches well in each case, in particular, for the corpus callosum and three crossing phantoms, the simulated signal matches the real signal closely. The b = \SI{3}{\milli\second\per\micro\metre\squared} signal in the internal capsule and corpus callosum is lower in simulation than in real data. This is to be expected however because as $|n\cdot G|$ approaches 1, the signal reaches the noise floor and the noise-free simulations fall below the measured data. Supplementary Figure 3 shows the difference between the simulated and measured signal in 3D.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/hcp_vs_sim_new_review_2_whitebg.png}
  \caption[dMRI signals from HCP subject and ConFiG phantoms ]{Comparison of diffusion MRI simulations and real data from three different brain regions:  a) a voxel  in the midbody of the corpus callosum, with phantom with volume fraction 55\% and mean orientation from z 25 o. b) a voxel  in which there are three crossing bundles, with phantom of three crossing bundles with volume fraction 50\% and c) a voxel in the internal capsule, with phantom with volume fraction 58\% and mean orientation from z 22o. Top row shows the ConFiG phantom and corresponding WM voxel. Middle row shows the direction dependent signal for ConFiG (lines) and HCP data (dots). Bottom row shows the direction averaged signal. Black lines correspond to phantom in top row. Grey lines are signal from phantoms with the same orientation distribution as the black line in each plot but different densities to show that ConFiG has the flexibility to generate a wide range of realistic signals. Simulations performed with 105 spins, 2000 timesteps, diffusivity 2.0micrometersquaredpermillsecond  and HCP measurement scheme (Stamatios N. Sotiropoulos et al., 2013). }
  \label{fig:config_res_dMRI}
\end{figure}

\section{Discussion}
\label{sec:config_discussion}
ConFiG is shown to produce substrates with microstructural properties comparable to real white matter, both in terms of measures derived from histology (i.e., electron microscopy) and in terms of the diffusion MRI signal.

ConFiG is shown to produce WM numerical phantoms with state-of-the-art performance. The amount of real data containing 3D microstructural morphology information available to compare to is limited, so we have only compared to one sample in this study. Whilst limited, this shows that ConFiG is able to produce realistic microstructure by following simple biologically inspired growth rules.

\Cref{fig:config_res_slice_wise_metrics} demonstrates that ConFiG phantoms are able to create fibre morphologies that match real axons much more closely than previous methods based on cylinders. Whilst some of the features such as eccentricity may be achievable with cylinders oriented obliquely to the cutting plane, ConFiG phantoms capture morphological features that are otherwise impossible with cylinders such as convexity less than one.

Whilst the input morphological priors do not necessarily correspond to the morphology of the resulting ConFiG phantom, Table 2 shows that even for relatively high orientation dispersion and density, this effect is small. Even so, for use in further analysis, microstructural measures such as orientation dispersion and density should be calculated based on the resultant phantom, rather than taking the input microstructural parameters.

A related property of ConFiG is that the growth algorithm strongly depends on the growth network, meaning that the resulting phantom for the same input fibre configuration will be different for different network choices. This is alleviated to an extent by using the dynamic network introduced here, however the phantom will still be dependent on the initialisation of the network. The dependence appears to be relatively minor as is demonstrated by the small standard errors on the mean density shown in \Cref{fig:config_res_improvements} across the five repetitions.

The diffusion MRI simulations shown in \Cref{fig:config_res_dMRI} demonstrate the ability of ConFiG to generate phantoms which reproduce real diffusion MRI data well. These simulations, however, are just three examples of ConFiG phantoms and corresponding simulations. Using NODDI as input to ConFiG means that the resulting phantoms have sensible morphologies and are shown to generate signals that match the real tissue well, though there may be other configurations that can better reproduce the signal. As an example, the b = \SI{3}{\milli\second\per\micro\metre\squared} signal from the internal capsule is higher at low $|n\cdot G|$ in the simulated versus the real data (~\Cref{fig:config_res_dMRI}c). One explanation of this is that the phantom generated does not have microstructure accurately representing this region, for instance the phantom may have too little dispersion caused by ConFiG underrepresenting the target orientation dispersion, as seen at low $\kappa$ in Table 2.

 It may be possible to find a better matching phantom using a computational modelling approach such as that proposed in \cite{Nedjati-Gilani2017}, however the simulations presented are sufficient to demonstrate a proof-of-concept that ConFiG can be used to generate realistic simulated dMRI data.

\subsection*{Limitations and future work}
\label{sec:config_limitations_future}
One limitation of ConFiG is that the algorithm relies on the space being sufficiently densely sampled by the growth network. This can require a large number of nodes for a large phantom, becoming prohibitively memory expensive. The dependence of the resulting phantom on the density of network nodes can be addressed by growing the fibres in small subregions local to the head of the fibres rather than the whole space at once. For instance, rather than filling the entire space of growth with nodes, it is possible to fill a small layer of the space with points and then grow layer by layer. In this way, it is possible to achieve a high density of nodes using fewer nodes than when covering the entire space.

One further potential limitation of ConFiG is that once a fibre has grown, it is static. The fibre will remain fixed in place and all other fibres will have to grow around it. One problem with this is that once the fibres are fixed, they may create pockets of inaccessible space which limits the space available for following fibres. Additionally, in real tissue, axons are flexible and non-rigid, meaning that it may be more realistic that growing fibres can push existing fibres out of the way to make more space for growth. A potential approach to ameliorate this would be to have an optimisation procedure during growth, similar to the global optimisation introduced in this work but optimising the shape of a fibre as it grows.

A limitation of the current study is that the simulations assume a single diffusivity for the intra and extracellular spaces and no permeability of the axonal membranes. Furthermore, effects such as T2 and magnetic susceptibility are ignored. These effects are a limitation of the simulator used rather than ConFiG, and work is planned to improve these aspects of the simulator for more realistic simulated signals.

Additionally, as mentioned above, this study only compares ConFiG to one EM sample of real tissue. Future work will also aim at more extensive validation of the digital phantoms generated using ConFiG, making comparison with larger EM dataset, including different WM configurations from different brain regions.

We will work towards decreasing the difference between the input and output morphological measures, particularly in complex situations, such as high orientation dispersion and crossing bundles. This can be addressed through the improvements to ConFiG mentioned here and also by improving the strategy for the generation of starting and target points for each fibre. For instance, currently it is not intuitive how starting and target points should be arranged to achieve a desired density in crossing regions of fibres.

One planned extension of ConFiG is to implement periodic boundary conditions in the growth network, enabling the generation of fully periodic phantoms. This would enable ConFiG phantoms to be generated in relatively small volumes and tiled for simulation, accelerating the process of generating a wide range of phantoms and the memory required to store each phantom.

The core growth algorithm for ConFiG relies on a set of starting and target points, a connected network of nodes and some rules defining the growth. As such, ConFiG is very flexible since the exact form of each of these components can be modified based on the application. One example of a simple modification that may be explored is the order of growth of the axons. Currently, in the absence of any clear biological precedent know to the authors, fibres grow in a random order, but it may be possible that there is a better order such as growing large diameter axons first, or central axons in a bundle growing first.

In this work, ConFiG is applied to the case of densely packed axons, without contributions from neuronal cell bodies or other processes. A planned future extension of ConFiG is to allow for the addition of glial cells such as astrocytes and oligodendrocytes \cite{Palombo2019} to the extracellular space to make the virtual WM tissue more realistic.

Additionally, to further add to the realism of ConFiG phantoms, realistic myelin may be modelled, creating spiral layers wrapped around the axons \cite{Brusini2019}. Furthermore, intra-axonal structures such as mitochondria and microtubules may be added to investigate their contributions to the diffusion weighted signal.

A planned future application will be to use ConFiG to generate a wide range of phantoms with different microstructural features. These can then be used to create a computational model to estimate microstructural features directly from the diffusion MRI signal in an approach similar to previous works \cite{Hill2019,Palombo2018a,Palombo2016,Nedjati-Gilani2017,Rensonnet2018}.

\subsection*{Applications beyond diffusion MRI}
\label{sec:config_beyond_dmri}
As mentioned in the introduction, axonal configuration impacts MR signals beyond dMRI. One potential avenue of exploration would be to investigate the impact of realistic axonal configurations on magnetic susceptibility in a similar way to Xu et al. \cite{Xu2018}, extending their 2D simulations to use realistic 3D geometries generated in ConFiG.

The virtual histology presented in \Cref{fig:config_res_real_vs_virt_hist} shows an approximation of electron microscopy generated using ConFiG substrates. In this work, the purpose of this is to show that ConFiG is generating microstructurally realistic phantoms. For this reason, the virtual histology is simply produced by rendering images to have similar contrast to electron microscopy for comparison. It may be possible, however to generate more realistic electron microscopy images using a physically realistic electron microscopy simulator \cite{Ophus2017,Grella2003,Babin2010} which may be used to train and test axon segmentation routines. This may be of particular use for cases of fibres parallel to the electron microscopy plane or crossing bundles which are typically difficult for 3D reconstruction and segmentation algorithms.

The 3D meshes generated by ConFiG are saved in the PLY format, a widely used format for storing meshes for many purposes. This means that the ConFiG phantoms may be used in other types of simulations such as polarized light imaging \cite{Matuschke2019,Menzel2015} or molecular dynamics simulations using software such as MCell (\url{https://mcell.org}) \cite{Kerr2008a,Stiles2001,Stiles1996} or LAMMPS (\url{http://lammps.sandia.gov}) \cite{Plimpton1997}.

\section{Conclusion}
\label{sec:config_conclusion}
ConFiG enables the generation of realistic white matter numerical phantoms achieving state of the art fibre density whilst ensuring realistic microstructural morphology by following biologically motivated rules. This realistic microstructure is shown to generate realistic simulated diffusion MRI signals, opening up the possibility to use ConFiG to create a realistic computational model of WM microstructure.
ConFiG outputs fibre meshes which can be used for realistic diffusion MRI simulations or can be processed to produce virtual histological slices, allowing for further potential applications outside of diffusion MRI.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
