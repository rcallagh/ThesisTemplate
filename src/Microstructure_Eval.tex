\chapter{Microstructural Evaluation}
\label{chap:microstructure_eval}

\chaptertoc{}

\begin{chapterabstract}
  This chapter presents a series of experiments performed using ConFiG phantoms to test their microstructural realism, something essential to prove the value of ConFiG phantoms.

  Firstly, the methodology used to calculate microstructural features from ConFiG phantom meshes are presented. The dependency of some of these features on the input morphology is demonstrated, followed by a series of experiments which compare ConFiG phantoms to real white matter reconstructed from electron microscopy. 
\end{chapterabstract}



\section{Introduction}
\label{sec:micro_introduction}
As demonstrated in \Cref{chap:config}, ConFiG is able to generate \acf{WM} numerical phantoms which can be used to generate realistic simulated \acf{dMRI} signals. Whilst this a valuable sanity check, this does not guarantee that the underlying microstructure is realistic since simplistic representations such as straight parallel cylinders can be used to generate realistic signals in certain cases.

To investigate how well axons generated using ConFiG represent real \ac{WM} axons, a series of experiments were conducted to compare ConFiG axons to real axons reconstructed from \acf{EM}. Typical \ac{EM} technqiues such as \acf{SEM} and \acf{TEM} provide only 2D images of tissue cross-sections, giving only limited information on axonal morphology. Recent technological improvements - primarily improvements and increased accessibility of \acf{SBEM}\cite{Helmstaedter2008,Denk2004}, a technique to take \ac{SEM} images of sequential tissue slices - have enabled new possibilities for the study of axonal microstructure in 3D.

Although high-resolution 3D imaging of tissue is possible using these \ac{SBEM} techniques, segmentation and quantification of the resulting images has remained challenging, meaning that there have only been a few studies investigating the 3D microstructure of segmented axons in \ac{WM} \cite{Abdollahzadeh2019,Lee2019b,Salo2018}. Of these, only Lee et al.\ \cite{Lee2019b} have made their axonal segmentations publicly available so it is this data set that we use to compare with ConFiG.

The rest of the chapter is arranged as follows, \Cref{sec:micro_measurements} describes the procedures used to extract microstructural features from the 3D meshes generated by \ac{ConFiG}.~\Cref{sec:micro_experiments} outlines a set of experiments that were performed using these microstructural measurement techniques to assess how the complexity of fibre arrangements affect the axonal morphology and to compare ConFiG axons to real axons segmented from EM. \Cref{sec:micro_results} presents the results of these experiments and \Cref{sec:micro_discussion} summarises the contributions and discusses future work.


\section{Microstructural measurements}
\label{sec:micro_measurements}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/centre_line_extraction-01.png}
  \caption[Mesh centreline extraction]{Centre line extraction of fibres. Each fibre was sliced N times along the z-axis, connecting the centre of mass of each slice to create the points in the centre line. This line could then be optionally smoothed according the diffusion time coarse graining effect, as in \cite{Lee2019b}}
  \label{fig:config_micro_centreline}
\end{figure}

In order to test how realistic the microstructure generated using ConFiG is, microstructural measurements of diameter distribution and orientation distribution were calculated using methods to be comparable with previous studies on ex-vivo tissue \cite{Abdollahzadeh2019,Lee2019b}.

A centre line is generated from each of the fibre meshes by aligning the ends of each fibre with the z-axis and connecting the centre of mass of 100 equidistant slices through each fibre, following the approach taken by Lee et al., \cite{Lee2019b}. This is illustrated in \Cref{fig:config_micro_centreline}.

Each segment in this centre line could then be used to assess the microstructure of the phantom. The direction of each segment was used to assess the orientation distribution of the phantom, illustrated in \Cref{fig:config_micro_OD}. Following the approach of Lee et al., \cite{Lee2019b}, the direction of each segment was projected onto the surface of a triangulated unit sphere \cite{Womersley2018}. For each triangle, the number of segments pointing in that direction was used to colour the triangle to visualise the orientation distribution.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/od_calculation-01_sym_whitebg.png}
  \caption[Orientation distribution extraction from microstructure]{Orientation distribution calculation. Each segment of a fibre was projected onto the surface of a triangulated sphere, here illustrated with a sectioned circle. For each section in the sphere, the number of fibre segments going through that section was used to colour and/or raise the surface to visualise the orientation distribution. Since the diffusion process is symmetric about the origin, each fibre segment was projected onto the sphere forwards and backwards.}
  \label{fig:config_micro_OD}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/diam_calculation-01.png}
  \caption[Diameter distribution extraction from microstructure]{Calculation of the diameter distribution. A slice is taken through each fibre perpendicular to every segment in the centre line. The area of each of these slices is used to find a circle equivalent radius or diameter using $A = \pi r^2$. }
  \label{fig:config_micro_diam}
\end{figure}

A second approach was devised to better visualise orientation distributions in 3D to aid differentiation of crossing bundles and antipodal symmetry. In this approach each vertex was raised above the surface of the sphere proportionally to the number of segments pointing in its direction as illustrated in \Cref{fig:config_micro_OD}.

To measure the diameter profile along fibres, the direction of each segment gave the normal to a plane used to cut the fibre using Boolean intersection to give a cross section of each fibre at each segment. The diameter profile along the axon was generated by calculating the equivalent diameter of a circle with the same area as the fibre cross section. This process is illustrated in \Cref{fig:config_micro_diam}.

\subsection{Virtual Histology and 2D morphological measures}
\label{sec:confg_virtual_histology}
Virtual histological slices were generated to compare ConFiG substrates to real white matter analysed using histology. Histological slices were found by calculating the Boolean intersection of a cutting plane with the generated fibre meshes using Blender (\url{https://blender.org}). A myelin sheath was added to the fibres when generating virtual histology for visualisation purposes.  Virtual histological images were rendered with a resolution of \SI{5 x 5 x 100}{\nano\metre}, chosen to be comparable to real histological white matter measurements \cite{Abdollahzadeh2019,Lee2019b}.

In order to compare ConFiG virtual histology to real histology, virtual histological slices were rendered in binary black and white to compare against intra-axonal segmentations from \cite{Lee2019b}. Slices from real histology, ConFiG phantoms and a parallel cylinder phantom were processed using the MorphoLibJ plugin for ImageJ \cite{Rueden2017,Legland2016,Schindelin2012,Schneider2012} to extract morphological features: circularity ($4\pi$ × Area/Perimeter$^2$), convexity (Area of shape/Area of convex hull), eccentricity of fitted ellipse and Area/$\pi r_{max}^2$ for each axon. Axons touching the edge of the image were removed since truncation from the image edge would skew these microstructural metrics.

\section{Experiments}
\label{sec:micro_experiments}

\subsection{Relationship between input and output morphology}
\label{sec:config_input_output_rel}
As mentioned in \Cref{sec:config_methods}, the nature of the ConFiG growth algorithm means that the microstructural morphology of the phantoms may not match the user input. Some fibres may become stuck and fibres cannot typically grow in a straight line, affecting the density and orientation distribution.

To investigate this, we generated a series of ConFiG phantoms with Watson distributed orientation dispersion with $\kappa=[8,10,15,20,30,50,100]$ and target density, $\rho = 75$\%. The target density of 75\% is chosen as this is the upper limit of what is achievable empirically and towards the higher end of expected axonal volume fraction. Additionally, with 75\% achieved, lower densities can be generated easily, either by running ConFiG in full, or simply by removing or shrinking fibres.

The mean and standard deviation of the angle from $z$, $\mu_\theta$ and $\sigma_\theta$ respectively, for each $\kappa$ was calculated by taking $10000$ samples from the Watson distribution and this was compared to $\mu_\theta$ and $\sigma_\theta$ of the ConFiG fibres. Additionally, the density of the ConFiG phantoms was compared to the target density of 75\%. Each phantom was generated in a \SI{20 x 20 x 20}{\micro\metre} region, using \num{2.5e6} nodes in the growth network.

\section{Results}
\label{sec:micro_results}

\subsection{Microstructural measures and virtual histology}
\label{sec:config_result_micro_meas}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/virthist1_wbox_whitebg.png}
  \caption[Comparison of real and virtual histology]{Comparison of real  and virtual histology. A) Light microscopy of rat ventromedial WM in thoracic spinal cord. Reproduced from Baxi et al. 2015 (Baxi et al., 2015), scale bar 2microm. B) Two virtual histological slices from a ConFiG generated phantom. Phantoms are rendered to have similar col ours to electron microscopy studies. The exact contrast and fibre bundle configurations are different between the real and virtual tissues, but the general morphology of the myelinated axons are captured well using ConFiG as highlighted by corresponding boxes. Yellow and Blue: axons severely deformed between other axons. Red: Pockets of empty space forming. Green: Largely circular axon surrounded by other axons deforming around it. Scale bar 2microm.}
  \label{fig:config_res_real_vs_virt_hist}
\end{figure}

The microstructural morphology generated using ConFiG is comparable to results from real data as demonstrated in \Cref{fig:config_res_real_vs_virt_hist,fig:config_res_slice_wise_metrics,fig:config_res_diameter_dist,fig:config_res_OD}.~\Cref{fig:config_res_real_vs_virt_hist} demonstrates virtual histology of a ConFiG phantom alongside a real EM image from mouse corpus callosum \cite{Baxi2015}. The exact microstructural features, such as diameter distribution, as well as the EM contrast do not exactly match between ConFiG and the real data. However, ConFiG is able to capture the general morphology or real axons as highlighted in \Cref{fig:config_res_slice_wise_metrics,fig:config_res_diameter_dist}. In particular, ConFiG is able to capture complex fibre cross-sections such as in the case of fibres squashed into small spaces. This is the first model of white matter able to handle complex fibre cross-sections such as this to our knowledge.

ConFiG morphological metrics calculated slice-wise on the virtual histology correspond much more closely to real axons than the same metrics calculated for parallel cylinders, as shown in \Cref{fig:config_res_slice_wise_metrics}. While cylinders produce a delta function at one extreme of each metric, ConFiG phantoms produce much closer distributions to the real data. Supplementary Figure 2 shows each of these slices coloured by their morphological metrics.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/slice_wise_metrics_whitebg.png}
  \caption[Slice-wise microstructural measurements]{Slice wise morphological metrics calculated for real axons, ConFiG phantoms and parallel cylinders. Across each of the metrics, ConFiG produces much more realistic distributions than  the cylinder phantom. Some of the cylinders have a non-zero eccentricity, but this arises since the metrics are calculated from binary images where the pixelated circles may appear to not be perfectly circular.}
  \label{fig:config_res_slice_wise_metrics}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/diameter_dist_NEW_whitebg.png}
  \caption[Diameter distributions of real and ConFiG axons]{a) Along fibre diameter variation in ex vivo mouse corpus callosum, reproduced from (Lee et al., 2019) compared to along axis diameter variation in the phantom inset demonstrating the ability of ConFiG to generate realistic microstructure. b) Histograms of the inner diameter of axons from (Lee et al., 2019) and diameter of ConFiG axons. c) Coefficient of variation along axons for real and ConFiG axons and d) Three example fibres reconstructed from the EM data used by Lee et al. to make a). d) Three example ConFiG fibres selected for similarity to the EM examples }
  \label{fig:config_res_diameter_dist}
\end{figure}

The diameter distribution of a ConFiG substrate is compared to a reconstruction from real EM data \cite{Lee2019b} in \Cref{fig:config_res_diameter_dist}. ConFiG is able to capture the general profile of axonal variations well, with the overall shape of the diameter distribution matching well. The distribution of the coefficient of variation along ConFiG axons is slightly narrower with a smaller mean than real axons, though these discrepancies may be alleviated with a different choice of input parameters to ConFiG.

ConFiG is also able to generate orientation distributions comparable to real tissue as shown in \Cref{fig:config_res_OD}. The orientation dispersion is introduced to ConFiG phantoms using the elliptically symmetrical angular Gaussian \cite{Paine2018} to best approximate the EM data and also using isotropic Watson distributed directions to demonstrate the flexibility of ConFiG.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/config/OD_ESAG_wcolorbar_wiso_sym_whitebg.png}
  \caption[Orientation distributions from real WM and ConFiG phantoms]{Dispersion profiles for EM data and a series of numerical phantoms. Top row: EM data used to generate OD profile, reproduced from Lee et al. (Lee et al., 2019) and three ConFiG phantoms with one, two and three crossing bundles (each crossing bundle coloured a different shade of grey). Middle row: OD profile for real EM data and OD profiles corresponding to ConFiG phantoms above, generated using an elliptically symmetric dispersion. Bottom row: Three OD profiles generated from ConFiG phantoms generated using isotropic orientation dispersion. Colormap has units of \si{\per\steradian}. }
  \label{fig:config_res_OD}
\end{figure}

\subsection{Relationship between input and output morphology}
\label{sec:config_result_input_output_rel}
\begin{table}[]
\caption{Comparison between input microstructural parameters and the microstructure measured in the resulting ConFiG phantoms. For each phantom, an input target density, $\rho$, of 75\% was used with each phantom having a different value of $\kappa$ used in the Watson distribution. Each $\kappa$ is associated with a target $\mu_\theta$ and $\sigma_\theta$, the mean and standard deviation of the angle away from the main bundle direction. Angles reported in degrees.}
\label{tab:micro_input_vs_output}
\begin{tabular}{ccccccc}
  \toprule
  Input $\kappa$ & Input $\rho$ & Output $\rho$ & Target $\mu_\theta$ & Output $\mu_\theta$ & Target $\sigma_\theta$ & Output $\sigma_\theta$\\\midrule
8        & 75\%     & 70.6\%    & 19.60     & 17.46     & 11.32     & 9.92   \\
10       & 75\%     & 73.4\%    & 17.11     & 16.47     & 9.62      & 9.43   \\
15       & 75\%     & 73.4\%    & 13.60     & 13.93     & 7.37      & 8.75   \\
20       & 75\%     & 70.7\%    & 11.68     & 12.69     & 6.23      & 7.88   \\
30       & 75\%     & 72.0\%    & 9.45      & 11.60     & 5.02      & 6.60   \\
50       & 75\%     & 73.6\%    & 7.26      & 9.36      & 3.83      & 5.51   \\
100      & 75\%     & 74.9\%    & 5.10      & 7.75      & 2.68      & 4.23 \\\bottomrule
\end{tabular}
\end{table}

The morphology of ConFiG phantoms matches the input morphology well, as shown in \Cref{tab:micro_input_vs_output}. Whilst the input and output $\mu_\theta$ and $\sigma_\theta$, do not match exactly, the values are close and increasing the input $\mu_\theta$ and $\sigma_\theta$ also increases the output $\mu_\theta$ and $\sigma_\theta$. Additionally, the output density generally matches the input target density well, achieving higher densities than MEDUSA for the same angular dispersion. Supplementary Table 1 shows the same experiment run with a target density of 60\% to demonstrate ConFiG’s performance at lower densities.

These phantoms took an average of 6 hours to grow plus an average of 20 minutes for the meshing and microstructural measurement procedure, using 9.4GB of RAM on average. These values give an estimate of the time taken to generate a typical ConFiG phantom, though it is strongly dependent on user inputs (number of nodes in the network etc.).


\section{Discussion and Conclusion}
\label{sec:micro_discussion}

ConFiG is shown to produce WM numerical phantoms with state-of-the-art performance. The amount of real data containing 3D microstructural morphology information available to compare to is limited, so we have only compared to one sample in this study. Whilst limited, this shows that ConFiG is able to produce realistic microstructure by following simple biologically inspired growth rules.

\Cref{fig:config_res_slice_wise_metrics} demonstrates that ConFiG phantoms are able to create fibre morphologies that match real axons much more closely than previous methods based on cylinders. Whilst some of the features such as eccentricity may be achievable with cylinders oriented obliquely to the cutting plane, ConFiG phantoms capture morphological features that are otherwise impossible with cylinders such as convexity less than one.

Whilst the input morphological priors do not necessarily correspond to the morphology of the resulting ConFiG phantom, \Cref{tab:micro_input_vs_output} shows that even for relatively high orientation dispersion and density, this effect is small. Even so, for use in further analysis, microstructural measures such as orientation dispersion and density should be calculated based on the resultant phantom, rather than taking the input microstructural parameters.

\subsection{Limitations and Future Work}
\label{sec:micro_limitations}

Additionally, as mentioned above, this study only compares ConFiG to one EM sample of real tissue. Future work will also aim at more extensive validation of the digital phantoms generated using ConFiG, making comparison with larger EM dataset, including different WM configurations from different brain regions.

We will work towards decreasing the difference between the input and output morphological measures, particularly in complex situations, such as high orientation dispersion and crossing bundles. This can be addressed through the improvements to ConFiG mentioned here and also by improving the strategy for the generation of starting and target points for each fibre. For instance, currently it is not intuitive how starting and target points should be arranged to achieve a desired density in crossing regions of fibres.
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
